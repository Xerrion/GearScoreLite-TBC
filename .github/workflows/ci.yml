name: CI - Validate Addon

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate addon structure
      run: |
        echo "ðŸ” Validating GearScoreLite TBC Edition structure..."
        
        # Check required files exist
        required_files=(
          "GearScoreLite.lua"
          "GearScoreLite.toc"
          "informationLite.lua"
          "README.md"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          else
            echo "âœ“ Found: $file"
          fi
        done
        
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "âŒ Missing required files:"
          printf '  - %s\n' "${missing_files[@]}"
          exit 1
        fi
        
        echo "âœ… All required files present"
        
    - name: Validate TOC file
      run: |
        echo "ðŸ” Validating GearScoreLite.toc..."
        
        # Check TOC has required fields
        required_fields=(
          "Interface"
          "Title"
          "Version"
          "Author"
        )
        
        for field in "${required_fields[@]}"; do
          if grep -q "## $field:" GearScoreLite.toc; then
            echo "âœ“ Found TOC field: $field"
          else
            echo "âŒ Missing TOC field: $field"
            exit 1
          fi
        done
        
        # Check Interface version is 30300 (TBC compatible)
        if grep -q "## Interface: 30300" GearScoreLite.toc; then
          echo "âœ“ Interface version is TBC compatible (30300)"
        else
          echo "âŒ Interface version should be 30300 for TBC compatibility"
          exit 1
        fi
        
        echo "âœ… TOC file validation passed"
        
    - name: Validate Lua syntax
      run: |
        echo "ðŸ” Validating Lua syntax..."
        
        # Install Lua for syntax checking
        sudo apt-get update
        sudo apt-get install -y lua5.1
        
        lua_files=($(find . -name "*.lua" -type f))
        
        for file in "${lua_files[@]}"; do
          echo "Checking syntax: $file"
          if lua5.1 -l "$file" 2>/dev/null; then
            echo "âœ“ Syntax OK: $file"
          else
            echo "âŒ Syntax error in: $file"
            lua5.1 -l "$file"
            exit 1
          fi
        done
        
        echo "âœ… All Lua files have valid syntax"
        
    - name: Validate TBC scoring system
      run: |
        echo "ðŸ” Validating TBC scoring system..."
        
        # Check that TBC-specific formulas exist
        if grep -q "TBC_HIGH" informationLite.lua; then
          echo "âœ“ Found TBC_HIGH formula (Sunwell)"
        else
          echo "âŒ Missing TBC_HIGH formula"
          exit 1
        fi
        
        if grep -q "TBC_T6" informationLite.lua; then
          echo "âœ“ Found TBC_T6 formula (T6 raids)"
        else
          echo "âŒ Missing TBC_T6 formula"
          exit 1
        fi
        
        if grep -q "TBC\[" informationLite.lua; then
          echo "âœ“ Found TBC formula (T5 raids)"
        else
          echo "âŒ Missing TBC formula"
          exit 1
        fi
        
        if grep -q "TBC_LOW" informationLite.lua; then
          echo "âœ“ Found TBC_LOW formula (T4/Heroics)"
        else
          echo "âŒ Missing TBC_LOW formula"
          exit 1
        fi
        
        # Check that WotLK features are removed
        if grep -q "Titan.*Grip" GearScoreLite.lua; then
          echo "âŒ Found Titan's Grip code - should be removed for TBC"
          exit 1
        else
          echo "âœ“ Titan's Grip code properly removed"
        fi
        
        echo "âœ… TBC scoring system validation passed"
        
    - name: Generate test report
      run: |
        echo "ðŸ“Š Generating validation report..."
        
        cat > validation_report.md << 'EOF'
        # GearScoreLite TBC Edition - Validation Report
        
        ## âœ… Validation Results
        
        - **Addon Structure**: âœ… Pass
        - **TOC File**: âœ… Pass  
        - **Lua Syntax**: âœ… Pass
        - **TBC Scoring System**: âœ… Pass
        
        ## ðŸ“ Files Validated
        
        EOF
        
        find . -name "*.lua" -o -name "*.toc" -o -name "*.md" | sort >> validation_report.md
        
        echo "" >> validation_report.md
        echo "## ðŸŽ¯ TBC Features Confirmed" >> validation_report.md
        echo "" >> validation_report.md
        echo "- Four-tier TBC scoring system" >> validation_report.md
        echo "- WotLK features properly removed" >> validation_report.md
        echo "- Interface version 30300 (TBC compatible)" >> validation_report.md
        echo "- All required files present" >> validation_report.md
        
        cat validation_report.md
        
    - name: Upload validation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: validation-report
        path: validation_report.md
        retention-days: 30
